;; Generated by mirage.%%VERSION%%

(executable
 (name config)
 (flags (:standard -warn-error -A))
 (modules config)
 (libraries mirage))

(rule
 (targets key_gen.ml main.ml manifest.json manifest.ml)
 (deps config.ml mirage.context)
 (action
  (run ./config.exe configure --context-file mirage.context --dry-run)))

(executable
 (enabled_if (= %{context_name} "mirage-hvt"))
 (name main)
 (modes (native object))
 (libraries lwt mirage-bootvar-solo5 mirage-clock-freestanding mirage-logs
   mirage-runtime mirage-solo5)
 (link_flags -without-runtime -g -w +A-4-41-42-44 -bin-annot
   -strict-sequence -principal -safe-string)
 (modules (:standard \ config manifest))
 (foreign_stubs (language c) (names manifest))
 (forbidden_libraries unix))

(rule
 (targets manifest.c)
 (deps manifest.json (package solo5))
 (action
  (run solo5-elftool gen-manifest manifest.json manifest.c)))

(rule (copy %{lib:solo5-hvt:ldflags} solo5-hvt-ldflags))

(rule
 (target noop.hvt)
 (enabled_if (= %{context_name} "mirage-hvt"))
 (deps main.exe.o (package solo5-hvt) solo5-hvt-ldflags)
 (action
  (bash
   "ld main.exe.o -o %{target} $(cat solo5-hvt-ldflags)")))

(install
 (files noop.hvt)
 (enabled_if (= %{context_name} "mirage-hvt"))
 (section bin)
 (package noop)))

(rule
 (deps (package solo5))
 (action
  (copy %{lib:solo5-hvt:cflags} solo5-hvt-cflags)))

(rule
 (deps (package solo5))
 (action
  (copy %{lib:solo5-spt:cflags} solo5-spt-cflags)))

(rule
 (deps (package solo5))
 (action
  (copy %{lib:solo5-virtio:cflags} solo5-virtio-cflags)))

(rule
 (deps (package solo5))
 (action
  (copy %{lib:solo5-muen:cflags} solo5-muen-cflags)))

(rule
 (deps (package solo5))
 (action
  (copy %{lib:solo5-genode:cflags} solo5-genode-cflags)))
