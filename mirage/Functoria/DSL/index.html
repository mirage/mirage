<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>DSL (mirage.Functoria.DSL)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.4"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">mirage</a> &#x00BB; <a href="../index.html">Functoria</a> &#x00BB; DSL</nav><header class="odoc-preamble"><h1>Module <code><span>Functoria.DSL</span></code></h1><p>The Functoria DSL allows users to describe how to create portable and flexible applications. It allows to pass application parameters easily using command-line arguments either at configure-time or at runtime.</p><p>Users of the Functoria DSL composes their application by defining a list of <a href="#val-main" title="main">module</a> implementations, specify the command-line <a href="#type-key"><code>key</code></a> that are required and <a href="#combinators" title="combinators">combine</a> all of them together using <a href="http://dx.doi.org/10.1017/S0956796807006326">applicative</a> operators.</p><p>The DSL expression is then compiled into an <a href="#app" title="app">application builder</a>, which will, once evaluated, produced the final portable and flexible application.</p></header><nav class="odoc-toc"><ul><li><a href="#combinators">Combinators</a></li><li><a href="#keys">Keys</a></li><li><a href="#pkg">Package dependencies</a></li><li><a href="#app">Application Builder</a></li><li><a href="#devices">Devices</a></li><li><a href="#jobs">Jobs</a></li></ul></nav><div class="odoc-content"><h2 id="combinators"><a href="#combinators" class="anchor"></a>Combinators</h2><div class="odoc-spec"><div class="spec type anchored" id="type-typ"><a href="#type-typ" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a typ</span></span><span> = <span><span class="type-var">'a</span> <a href="../Type/index.html#type-t">Type.t</a></span></span></code></div><div class="spec-doc"><p>The type for values representing module types.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-typ"><a href="#val-typ" class="anchor"></a><code><span><span class="keyword">val</span> typ : <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-typ">typ</a></span></span></code></div><div class="spec-doc"><p><code>type t</code> is a value representing the module type <code>t</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-(@-&gt;)"><a href="#val-(@-&gt;)" class="anchor"></a><code><span><span class="keyword">val</span> (@-&gt;) : <span><span><span class="type-var">'a</span> <a href="#type-typ">typ</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'b</span> <a href="#type-typ">typ</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <a href="#type-typ">typ</a></span></span></code></div><div class="spec-doc"><p>Construct a functor type from a type and an existing functor type. This corresponds to prepending a parameter to the list of functor parameters. For example:</p><pre class="language-ocaml"><code>kv_ro @-&gt; ip @-&gt; kv_ro</code></pre><p>This describes a functor type that accepts two arguments -- a <code>kv_ro</code> and an <code>ip</code> device -- and returns a <code>kv_ro</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-impl"><a href="#type-impl" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a impl</span></span><span> = <span><span class="type-var">'a</span> <a href="../Impl/index.html#type-t">Impl.t</a></span></span></code></div><div class="spec-doc"><p>The type for values representing module implementations.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-($)"><a href="#val-($)" class="anchor"></a><code><span><span class="keyword">val</span> ($) : <span><span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="#type-impl">impl</a></span></span></code></div><div class="spec-doc"><p><code>m $ a</code> applies the functor <code>m</code> to the module <code>a</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-abstract_impl"><a href="#type-abstract_impl" class="anchor"></a><code><span><span class="keyword">type</span> abstract_impl</span><span> = <a href="../Impl/index.html#type-abstract">Impl.abstract</a></span></code></div><div class="spec-doc"><p>Same as <a href="#type-impl"><code>impl</code></a> but with hidden type.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-dep"><a href="#val-dep" class="anchor"></a><code><span><span class="keyword">val</span> dep : <span><span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-abstract_impl">abstract_impl</a></span></code></div><div class="spec-doc"><p><code>dep t</code> is the (build-time) dependency towards <code>t</code>.</p></div></div><h2 id="keys"><a href="#keys" class="anchor"></a>Keys</h2><div class="odoc-spec"><div class="spec type anchored" id="type-key"><a href="#type-key" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a key</span></span><span> = <span><span class="type-var">'a</span> <a href="../Key/index.html#type-key">Key.key</a></span></span></code></div><div class="spec-doc"><p>The type for configure-time command-line arguments.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-runtime_arg"><a href="#type-runtime_arg" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a runtime_arg</span></span><span> = <span><span class="type-var">'a</span> <a href="../Runtime_arg/index.html#type-arg">Runtime_arg.arg</a></span></span></code></div><div class="spec-doc"><p>The type for runtime command-line arguments.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-runtime_arg"><a href="#val-runtime_arg" class="anchor"></a><code><span><span class="keyword">val</span> runtime_arg : 
  <span><span class="label">pos</span>:<span>(string * int * int * int)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?packages</span>:<span><a href="../Package/index.html#type-t">Package.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <a href="../Runtime_arg/index.html#type-t">Runtime_arg.t</a></span></code></div><div class="spec-doc"><p><code>runtime_arg ~pos ?packages v</code> is the runtime argument pointing to the value <code>v</code>. <code>pos</code> is expected to be <code>__POS__</code>. <code>packages</code> specifies in which opam package the value <code>v</code> is defined.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-abstract_key"><a href="#type-abstract_key" class="anchor"></a><code><span><span class="keyword">type</span> abstract_key</span><span> = <a href="../Key/index.html#type-t">Key.t</a></span></code></div><div class="spec-doc"><p>The type for abstract keys.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-context"><a href="#type-context" class="anchor"></a><code><span><span class="keyword">type</span> context</span><span> = <a href="../Context/index.html#type-t">Context.t</a></span></code></div><div class="spec-doc"><p>The type for keys' parsing context. See <code>Key.context</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-value"><a href="#type-value" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a value</span></span><span> = <span><span class="type-var">'a</span> <a href="../Key/index.html#type-value">Key.value</a></span></span></code></div><div class="spec-doc"><p>The type for values parsed from the command-line. See <a href="../Key/index.html#type-value"><code>Key.value</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-key"><a href="#val-key" class="anchor"></a><code><span><span class="keyword">val</span> key : <span><span><span class="type-var">'a</span> <a href="#type-key">key</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="../Key/index.html#type-t">Key.t</a></span></code></div><div class="spec-doc"><p><code>key k</code> is an untyped representation of <code>k</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-if_impl"><a href="#val-if_impl" class="anchor"></a><code><span><span class="keyword">val</span> if_impl : <span><span>bool <a href="#type-value">value</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span></span></code></div><div class="spec-doc"><p><code>if_impl v impl1 impl2</code> is <code>impl1</code> if <code>v</code> is resolved to true and <code>impl2</code> otherwise.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-match_impl"><a href="#val-match_impl" class="anchor"></a><code><span><span class="keyword">val</span> match_impl : <span><span><span class="type-var">'b</span> <a href="#type-value">value</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">default</span>:<span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'b</span> * <span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span>)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span></span></code></div><div class="spec-doc"><p><code>match_impl v cases ~default</code> chooses the implementation amongst <code>cases</code> by matching the <code>v</code>'s value. <code>default</code> is chosen if no value matches.</p></div></div><h2 id="pkg"><a href="#pkg" class="anchor"></a>Package dependencies</h2><p>For specifying opam package dependencies, the type <a href="#type-package"><code>package</code></a> is used. It consists of the opam package name, the ocamlfind names, and optional lower and upper bounds. The version constraints are merged with other modules.</p><div class="odoc-spec"><div class="spec type anchored" id="type-package"><a href="#type-package" class="anchor"></a><code><span><span class="keyword">type</span> package</span><span> = <a href="../Package/index.html#type-t">Package.t</a></span></code></div><div class="spec-doc"><p>The type for opam packages.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-scope"><a href="#type-scope" class="anchor"></a><code><span><span class="keyword">type</span> scope</span><span> = <a href="../Package/index.html#type-scope">Package.scope</a></span></code></div><div class="spec-doc"><p>Installation scope of a package.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-package"><a href="#val-package" class="anchor"></a><code><span><span class="keyword">val</span> package : 
  <span><span class="optlabel">?scope</span>:<a href="#type-scope">scope</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?build</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?sublibs</span>:<span>string list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?libs</span>:<span>string list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?min</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?max</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?pin</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?pin_version</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-package">package</a></span></code></div><div class="spec-doc"><p><code>package ~scope ~build ~sublibs ~libs ~min ~max ~pin opam</code> is a <code>package</code>. <code>Build</code> indicates a build-time dependency only, defaults to <code>false</code>. The library name is by default the same as <code>opam</code>, you can specify <code>~sublibs</code> to add additional sublibraries (e.g. <code>~sublibs:[&quot;mirage&quot;] &quot;foo&quot;</code> will result in the library names <code>[&quot;foo&quot;; &quot;foo.mirage&quot;]</code>. In case the library name is disjoint (or empty), use <code>~libs</code>. Specifying both <code>~libs</code> and <code>~sublibs</code> leads to an invalid argument. Version constraints are given as <code>min</code> (inclusive) and <code>max</code> (exclusive). If <code>pin</code> is provided, a <a href="https://opam.ocaml.org/doc/Manual.html#opamfield-pin-depends">pin-depends</a> is generated, <code>pin_version</code> is <code>&quot;dev&quot;</code> by default. <code>~scope</code> specifies the installation location of the package.</p></div></div><h2 id="app"><a href="#app" class="anchor"></a>Application Builder</h2><p>Values of type <a href="#type-impl"><code>impl</code></a> are tied to concrete module implementation with the <a href="#type-device"><code>device</code></a> and <a href="#val-main"><code>main</code></a> construct. Module implementations of type <a href="#type-job"><code>job</code></a> can then be <a href="../Lib/Make/index.html#val-register" title="Functoria.Lib.Make.register">registered</a> into an application builder. The builder is in charge if parsing the command-line arguments and of generating code for the final application. See <a href="../Lib/index.html"><code>Functoria.Lib</code></a> for details.</p><div class="odoc-spec"><div class="spec type anchored" id="type-info"><a href="#type-info" class="anchor"></a><code><span><span class="keyword">type</span> info</span><span> = <a href="../Info/index.html#type-t">Info.t</a></span></code></div><div class="spec-doc"><p>The type for build information.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-main"><a href="#val-main" class="anchor"></a><code><span><span class="keyword">val</span> main : 
  <span><span class="optlabel">?pos</span>:<span>(string * int * int * int)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?packages</span>:<span><a href="#type-package">package</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?packages_v</span>:<span><span><a href="#type-package">package</a> list</span> <a href="#type-value">value</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?runtime_args</span>:<span><a href="../Runtime_arg/index.html#type-t">Runtime_arg.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?deps</span>:<span><a href="#type-abstract_impl">abstract_impl</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-typ">typ</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span></span></code></div><div class="spec-doc"><p><code>main name typ</code> is the functor <code>name</code>, having the module type <code>typ</code>. The connect code will call <code>&lt;name&gt;.start</code>.</p><ul><li>If <code>packages</code> or <code>packages_v</code> is set, then the given packages are installed before compiling the current application.</li></ul></div></div><h2 id="devices"><a href="#devices" class="anchor"></a>Devices</h2><div class="odoc-spec"><div class="spec type anchored" id="type-code"><a href="#type-code" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a code</span></span><span> = <span><span class="type-var">'a</span> <a href="../Device/index.html#type-code">Device.code</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-code"><a href="#val-code" class="anchor"></a><code><span><span class="keyword">val</span> code : 
  <span><span class="label">pos</span>:<span>(string * int * int * int)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'a</span>, <span class="xref-unresolved">Stdlib</span>.Format.formatter, unit, <span><span class="type-var">'b</span> <a href="#type-code">code</a></span>)</span> <span class="xref-unresolved">Stdlib</span>.format4</span> <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'a</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-device"><a href="#type-device" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a device</span></span><span> = <span><span>(<span class="type-var">'a</span>, <a href="#type-abstract_impl">abstract_impl</a>)</span> <a href="../Device/index.html#type-t">Device.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-of_device"><a href="#val-of_device" class="anchor"></a><code><span><span class="keyword">val</span> of_device : <span><span><span class="type-var">'a</span> <a href="#type-device">device</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span></span></code></div><div class="spec-doc"><p><code>of_device t</code> is the implementation device <code>t</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-impl"><a href="#val-impl" class="anchor"></a><code><span><span class="keyword">val</span> impl : 
  <span><span class="optlabel">?packages</span>:<span><a href="#type-package">package</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?packages_v</span>:<span><span><a href="#type-package">package</a> list</span> <a href="../Key/index.html#type-value">Key.value</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?install</span>:<span>(<span><a href="../Info/index.html#type-t">Info.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../Install/index.html#type-t">Install.t</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?install_v</span>:<span>(<span><a href="../Info/index.html#type-t">Info.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Install/index.html#type-t">Install.t</a> <a href="../Key/index.html#type-value">Key.value</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?keys</span>:<span><a href="../Key/index.html#type-t">Key.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?runtime_args</span>:<span><a href="../Runtime_arg/index.html#type-t">Runtime_arg.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?extra_deps</span>:<span><a href="#type-abstract_impl">abstract_impl</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?connect</span>:<span>(<span><a href="#type-info">info</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>string list</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-code">code</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?dune</span>:<span>(<span><a href="#type-info">info</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Dune/index.html#type-stanza">Dune.stanza</a> list</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?configure</span>:<span>(<span><a href="#type-info">info</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../Action/index.html#type-t">Action.t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?files</span>:<span>(<span><a href="#type-info">info</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Fpath</span>.t list</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-typ">typ</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span></span></code></div><div class="spec-doc"><p><code>impl ~packages ~packages_v ~install ~install_v ~keys ~runtime_args
     ~extra_deps ~connect ~dune ~configure ~files module_name module_type</code> is an implementation of the device constructed by the arguments. <code>packages</code> and <code>packages_v</code> are the dependencies (where <code>packages_v</code> is inside <a href="../Key/index.html#type-value"><code>Key.value</code></a>). <code>install</code> and <code>install_v</code> are the install instructions (used in the generated opam file), <code>keys</code> are the configuration-time keys, <code>runtime_args</code> the arguments at runtime, <code>extra_deps</code> are a list of extra dependencies (other implementations), <code>connect</code> is the code emitted for initializing the device, <code>dune</code> are dune stanzas added to the build rule, <code>configure</code> are commands executed at the configuration phase, <code>files</code> are files to be added to the list of generated files, <code>module_name</code> is the name of the device module, and <code>module_type</code> is the type of the module.</p></div></div><h2 id="jobs"><a href="#jobs" class="anchor"></a>Jobs</h2><div class="odoc-spec"><div class="spec type anchored" id="type-job"><a href="#type-job" class="anchor"></a><code><span><span class="keyword">type</span> job</span></code></div></div></div></body></html>
